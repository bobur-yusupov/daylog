{% extends "base.html" %}

{% block title %}Edit Entry - {{ entry.title }}{% endblock %}

{% block extra_css %}
<!-- Journal styles are now in main styles.css -->
{% endblock %}

{% block content %}
<body class="journal-page">
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-12 col-xl-8 col-lg-10">
            <form method="post" id="journal-form" class="py-4">
                {% csrf_token %}
                
                <!-- Title -->
                <div class="mb-4">
                    <input type="text" 
                           id="title" 
                           name="title" 
                           class="form-control border-0 fs-1 fw-light entry-title" 
                           value="{{ entry.title }}"
                           placeholder="What's on your mind today?"
                           required
                           maxlength="255">
                </div>

                <!-- Tags -->
                <div class="mb-1">
                    <div class="tag-input-container">
                        <input type="text" 
                               id="tag-input" 
                               class="form-control border-0 text-muted" 
                               placeholder="Add tags... (press Enter to add)"
                               autocomplete="off">
                        <div class="tag-suggestions" id="tag-suggestions"></div>
                    </div>
                    
                    <!-- Selected Tags -->
                    <div class="selected-tags mt-3" id="selected-tags"></div>
                </div>

                <!-- Content Editor -->
                <div class="mb-1">
                    <div id="editorjs"></div>
                    <input type="hidden" id="content" name="content">
                </div>

                <!-- Fixed bottom controls -->
                <div class="fixed-bottom journal-fixed-bottom bg-white border-top p-3">
                    <div class="container-fluid">
                        <div class="row justify-content-center">
                            <div class="col-12 col-xl-10">
                                <div class="d-flex justify-content-between align-items-center">
                                    <a href="{% url 'journal:entry_detail' entry.id %}" class="btn btn-link text-muted">
                                        <i class="bi bi-arrow-left me-1"></i>Back
                                    </a>
                                    
                                    <div class="d-flex align-items-center gap-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="is_public" name="is_public" 
                                                   {% if entry.is_public %}checked{% endif %}>
                                            <label class="form-check-label text-muted" for="is_public">
                                                <i class="bi bi-globe me-1"></i>Public
                                            </label>
                                        </div>
                                        
                                        <button type="submit" class="btn btn-primary rounded-pill px-4" id="save-btn">
                                            <i class="bi bi-check-lg me-1"></i>Save Changes
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
</body>

<!-- Pass data to JavaScript -->
<script>
    window.entryContent = {{ content_data|safe }};
    window.isEditMode = true;
    
    // Initialize existing tags
    document.addEventListener('DOMContentLoaded', function() {
        {% for tag in entry.tags.all %}
            if (typeof addTag === 'function') {
                addTag('{{ tag.name }}');
            }
        {% endfor %}
    });
</script>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/editorjs.css' %}">
{% endblock %}

{% block extra_js %}
<!-- EditorJS Core -->
<script src="https://cdn.jsdelivr.net/npm/@editorjs/editorjs@2.28.2/dist/editorjs.umd.js"></script>

<!-- EditorJS Plugins -->
<script src="https://cdn.jsdelivr.net/npm/@editorjs/header@2.7.0/dist/bundle.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/list@1.8.0/dist/bundle.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/checklist@1.5.0/dist/bundle.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/delimiter@1.3.0/dist/bundle.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/quote@2.5.0/dist/bundle.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/table@2.2.2/dist/table.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/link@2.5.0/dist/bundle.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/raw@2.4.0/dist/bundle.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/code@2.8.0/dist/bundle.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/warning@1.3.0/dist/bundle.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/marker@1.3.0/dist/bundle.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/underline@1.1.0/dist/bundle.js"></script>

<!-- EditorJS Service -->
<script src="{% static 'js/editorjs-service.js' %}"></script>

<script>
// Global variables for edit page
let originalContent = null;

// Entry content from Django template
window.entryContent = {{ content_data|safe }};
window.isEditMode = true;

// Initialize existing tags
document.addEventListener('DOMContentLoaded', function() {
    {% for tag in entry.tags.all %}
        if (typeof addTag === 'function') {
            addTag('{{ tag.name }}');
        }
    {% endfor %}

    // Initialize EditorJS using the service
    initializeEditEditor();
});

// Wait for essential EditorJS plugins to load
async function waitForPlugins() {
    const essentialPlugins = ['Header', 'List', 'Code'];
    const maxAttempts = 50; // 5 seconds max wait
    let attempts = 0;

    while (attempts < maxAttempts) {
        let allLoaded = true;

        for (const plugin of essentialPlugins) {
            if (typeof window[plugin] === 'undefined') {
                allLoaded = false;
                break;
            }
        }

        if (allLoaded) {
            console.log('All essential EditorJS plugins loaded');
            return;
        }

        attempts++;
        await new Promise(resolve => setTimeout(resolve, 100));
    }

    console.warn('Some EditorJS plugins may not be loaded, but continuing with available plugins');
}

async function initializeEditEditor() {
    try {
        // Wait for essential plugins to be available
        await waitForPlugins();

        // Initialize EditorJS using the service
        await window.editorJSService.initialize('editorjs', {
            initialData: window.entryContent,
            minHeight: 400,
            placeholder: 'Start writing your journal entry... Press Tab to see formatting options.',
            onChange: handleContentChange,
            onReady: () => {
                console.log('Edit editor ready');
                // Store original content for change detection
                originalContent = JSON.stringify(window.entryContent);
            }
        });

        // Initialize save button
        const saveBtn = document.getElementById('save-btn');
        if (saveBtn) {
            saveBtn.addEventListener('click', handleEditSave);
        }

    } catch (error) {
        console.error('Failed to initialize edit editor:', error);
        showErrorMessage('Failed to load editor. Please refresh the page.');
    }
}

function handleContentChange() {
    // Update save button to indicate changes
    const saveBtn = document.getElementById('save-btn');
    if (saveBtn) {
        saveBtn.innerHTML = '<i class="bi bi-check-lg me-1"></i>Save Changes*';
        saveBtn.classList.remove('btn-success');
        saveBtn.classList.add('btn-warning');
    }
}

async function handleEditSave(event) {
    event.preventDefault();

    const saveBtn = document.getElementById('save-btn');
    const titleInput = document.getElementById('title');
    const contentInput = document.getElementById('content');

    if (!window.editorJSService.isReady()) {
        showErrorMessage('Editor is not ready. Please wait and try again.');
        return;
    }

    try {
        // Show saving state
        if (saveBtn) {
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...';
        }

        // Get editor content
        const content = await window.editorJSService.getContent();

        // Get title
        const title = titleInput ? titleInput.value.trim() : '';

        if (!title) {
            showErrorMessage('Please enter a title for your entry.');
            if (saveBtn) {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="bi bi-check-lg me-1"></i>Save Changes*';
            }
            return;
        }

        // Set content in hidden input
        if (contentInput) {
            contentInput.value = JSON.stringify(content);
        }

        // Submit the form
        const form = document.getElementById('journal-form');
        if (form) {
            form.submit();
        }

    } catch (error) {
        console.error('Save failed:', error);
        showErrorMessage('Failed to save journal entry. Please check your content and try again.');
        if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="bi bi-check-lg me-1"></i>Save Changes*';
        }
    }
}

function showSuccessMessage(message) {
    showToast(message, 'success');
}

function showErrorMessage(message) {
    showToast(message, 'error');
}

function showToast(message, type = 'info') {
    // Create a temporary toast notification
    const toastColors = {
        success: 'bg-success',
        error: 'bg-danger',
        info: 'bg-primary'
    };

    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white ${toastColors[type]} border-0 position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="bi ${type === 'success' ? 'bi-check-circle' : type === 'error' ? 'bi-exclamation-triangle' : 'bi-info-circle'} me-2"></i>
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;

    document.body.appendChild(toast);

    // Initialize Bootstrap toast
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();

    // Auto remove after 3 seconds
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, 3000);
}
</script>
{% endblock %}
