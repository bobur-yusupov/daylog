{% extends "base.html" %}
{% load static %}

{% block title %}{{ entry.title }} - Daylog{% endblock %}

{% block extra_css %}
<!-- Journal styles are now in main styles.css -->
{% endblock %}

{% block content %}
<body class="journal-page">
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-12 col-xl-8 col-lg-10">
            <div class="py-4">
                
                <!-- Entry Title -->
                <div class="mb-4">
                    <h1 class="entry-title mb-0" id="entry-title">{{ entry.title }}</h1>
                </div>

                <!-- Tags Section -->
                {% if entry.tags.exists %}
                <div class="mb-4">
                    {% for tag in entry.tags.all %}
                        <a href="{% url 'journal:entry_list' %}?tag={{ tag.name|urlencode }}" class="tag-badge">{{ tag.name }}</a>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Entry Content -->
                <div class="mb-5">
                    <div class="entry-content" id="rendered-content">
                        <!-- Content will be rendered here by JavaScript -->
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- Fixed Bottom Controls -->
<div class="fixed-bottom journal-fixed-bottom bg-white border-top p-3">
    <div class="container-fluid">
        <div class="row justify-content-center">
            <div class="col-12 col-xl-10">
                <div class="d-flex justify-content-between align-items-center">
                    
                    <!-- Left side - Back button -->
                    <a href="{% url 'journal:dashboard' %}" class="btn btn-link text-muted">
                        <i class="bi bi-arrow-left me-1"></i>Back
                    </a>
                    
                    <!-- Right side - Actions -->
                    <div class="d-flex align-items-center gap-3">
                        <!-- Privacy indicator -->
                        <small class="text-muted">
                            <i class="bi {% if entry.is_public %}bi-globe{% else %}bi-lock{% endif %} me-1"></i>
                            {% if entry.is_public %}Public{% else %}Private{% endif %}
                        </small>
                        
                        <!-- Share button -->
                        <button class="btn btn-outline-primary btn-sm rounded-pill" data-bs-toggle="modal" data-bs-target="#shareModal">
                            <i class="bi bi-share me-1"></i>Share
                        </button>
                        
                        <!-- View Mode Actions -->
                        <a href="{% url 'journal:edit_entry' entry_id=entry.id %}" class="btn btn-primary rounded-pill px-4" id="edit-btn">
                            <i class="bi bi-pencil me-1"></i>Edit
                        </a>
                    </div>
                    
                </div>
            </div>
        </div>
    </div>
</div>
</body>

<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shareModalLabel">
                    <i class="bi bi-share me-2"></i>Share Journal Entry
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="shareContent">
                    {% if entry.share_token %}
                        <p class="text-muted">Anyone with this link can view this entry (read-only):</p>
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="shareUrl" value="{{ request.scheme }}://{{ request.get_host }}/share/{{ entry.share_token }}/" readonly>
                            <button class="btn btn-outline-secondary" type="button" id="copyBtn">
                                <i class="bi bi-clipboard"></i> Copy
                            </button>
                        </div>
                        <div class="alert alert-success d-none" id="copySuccess">
                            <i class="bi bi-check-circle me-1"></i>Link copied to clipboard!
                        </div>
                        <button class="btn btn-danger btn-sm" id="revokeBtn">
                            <i class="bi bi-x-circle me-1"></i>Revoke Share Link
                        </button>
                    {% else %}
                        <p class="text-muted">Generate a shareable link to allow others to view this entry (read-only).</p>
                        <button class="btn btn-primary" id="generateBtn">
                            <i class="bi bi-link-45deg me-1"></i>Generate Share Link
                        </button>
                    {% endif %}
                </div>
                <div id="shareLoading" class="d-none text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
{{ entry.content|json_script:"entry-content" }}

<script>
    // Entry content from Django template - make it globally available
    window.entryContent = {};
    
    try {
        const raw = document.getElementById('entry-content')?.textContent || '{}';
        window.entryContent = JSON.parse(raw);
        if (typeof window.entryContent === 'string') {
            try { 
                window.entryContent = JSON.parse(window.entryContent); 
            } catch { 
                window.entryContent = {}; 
            }
        }
    } catch (e) {
        console.warn('Failed to parse entry content JSON, defaulting to empty.', e);
        window.entryContent = {};
    }
    
    // Initialize content rendering when page loads
    document.addEventListener('DOMContentLoaded', function() {
        renderContent();
    });

    function renderContent() {
        const container = document.getElementById('rendered-content');
        
        if (!window.entryContent || !window.entryContent.blocks) {
            container.innerHTML = '<p class="text-muted">No content available.</p>';
            return;
        }

        const renderedHtml = window.entryContent.blocks.map(block => {
            switch(block.type) {
                case 'paragraph':
                    return `<p>${block.data.text || ''}</p>`;
                case 'header':
                    const level = block.data.level || 2;
                    return `<h${level}>${block.data.text || ''}</h${level}>`;
                case 'list':
                    const listItems = (block.data.items || []).map(item => {
                        if (typeof item === 'string') {
                            return `<li>${item}</li>`;
                        } else if (item.content) {
                            return `<li>${item.content}</li>`;
                        }
                        return '<li></li>';
                    }).join('');
                    const listType = block.data.style === 'ordered' ? 'ol' : 'ul';
                    return `<${listType}>${listItems}</${listType}>`;
                case 'checklist':
                    const checkItems = (block.data.items || []).map(item => {
                        const checked = item.checked ? 'checked' : '';
                        return `<div class="form-check">
                            <input class="form-check-input" type="checkbox" ${checked} disabled>
                            <label class="form-check-label">${item.text}</label>
                        </div>`;
                    }).join('');
                    return `<div class="checklist mb-3">${checkItems}</div>`;
                case 'quote':
                    return `<blockquote class="blockquote">
                        <p>${block.data.text || ''}</p>
                        ${block.data.caption ? `<footer class="blockquote-footer">${block.data.caption}</footer>` : ''}
                    </blockquote>`;
                case 'warning':
                    return `<div class="alert alert-warning" role="alert">
                        ${block.data.title ? `<h6 class="alert-heading">${block.data.title}</h6>` : ''}
                        <p class="mb-0">${block.data.message || ''}</p>
                    </div>`;
                case 'delimiter':
                    return '<hr>';
                case 'code':
                    return `<pre><code>${block.data.code || ''}</code></pre>`;
                case 'raw':
                    return block.data.html || '';
                case 'table':
                    if (!block.data.content || !Array.isArray(block.data.content)) return '';
                    const tableRows = block.data.content.map((row, index) => {
                        const cellTag = index === 0 && block.data.withHeadings ? 'th' : 'td';
                        const cells = row.map(cell => `<${cellTag}>${cell}</${cellTag}>`).join('');
                        return `<tr>${cells}</tr>`;
                    }).join('');
                    return `<table class="table table-bordered">${tableRows}</table>`;
                case 'linkTool':
                    return `<div class="card mb-3">
                        <div class="card-body">
                            <h6 class="card-title">
                                <a href="${block.data.link}" target="_blank" rel="noopener">
                                    ${block.data.meta?.title || block.data.link}
                                </a>
                            </h6>
                            ${block.data.meta?.description ? `<p class="card-text">${block.data.meta.description}</p>` : ''}
                        </div>
                    </div>`;
                default:
                    console.warn('Unsupported block type:', block.type);
                    return `<div class="alert alert-warning">Unsupported content type: ${block.type}</div>`;
            }
        }).join('');

        container.innerHTML = renderedHtml;
    }

    // Share functionality
    document.addEventListener('DOMContentLoaded', function() {
        const entryId = "{{ entry.id }}";
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                         document.querySelector('meta[name=csrf-token]')?.content;
        
        // Generate share link
        const generateBtn = document.getElementById('generateBtn');
        if (generateBtn) {
            generateBtn.addEventListener('click', function() {
                const shareContent = document.getElementById('shareContent');
                const shareLoading = document.getElementById('shareLoading');
                
                shareContent.classList.add('d-none');
                shareLoading.classList.remove('d-none');
                
                fetch(`/entry/${entryId}/share/generate/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Reload the page to show the new share URL
                        location.reload();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to generate share link. Please try again.');
                    shareLoading.classList.add('d-none');
                    shareContent.classList.remove('d-none');
                });
            });
        }
        
        // Copy share link to clipboard
        const copyBtn = document.getElementById('copyBtn');
        if (copyBtn) {
            copyBtn.addEventListener('click', function() {
                const shareUrl = document.getElementById('shareUrl');
                shareUrl.select();
                shareUrl.setSelectionRange(0, 99999); // For mobile devices
                
                navigator.clipboard.writeText(shareUrl.value).then(function() {
                    const copySuccess = document.getElementById('copySuccess');
                    copySuccess.classList.remove('d-none');
                    setTimeout(() => {
                        copySuccess.classList.add('d-none');
                    }, 3000);
                }).catch(function(error) {
                    console.error('Failed to copy:', error);
                    alert('Failed to copy link to clipboard');
                });
            });
        }
        
        // Revoke share link
        const revokeBtn = document.getElementById('revokeBtn');
        if (revokeBtn) {
            revokeBtn.addEventListener('click', function() {
                if (!confirm('Are you sure you want to revoke the share link? The current link will no longer work.')) {
                    return;
                }
                
                const shareContent = document.getElementById('shareContent');
                const shareLoading = document.getElementById('shareLoading');
                
                shareContent.classList.add('d-none');
                shareLoading.classList.remove('d-none');
                
                fetch(`/entry/${entryId}/share/revoke/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Reload the page to show the generate button again
                        location.reload();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to revoke share link. Please try again.');
                    shareLoading.classList.add('d-none');
                    shareContent.classList.remove('d-none');
                });
            });
        }
    });
</script>
{% endblock %}
